<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>County Colorer</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        body {
            margin-left: 2%;
            margin-bottom: 2%;
        }
    </style>
</head>

<body>
    <h1>County Colorer</h1>

    <label for="state">State/Territory to Color: </label>
    <select id="state">
        <optgroup label="States">
            <option value="AL">Alabama</option>
            <option value="AK">Alaska</option>
            <option value="AZ">Arizona</option>
            <option value="AR">Arkansas</option>
            <option value="CA">California</option>
            <option value="CO">Colorado</option>
            <option value="CT">Connecticut</option>
            <option value="DE">Delaware</option>
            <option value="FL">Florida</option>
            <option value="GA">Georgia</option>
            <option value="HI">Hawaii</option>
            <option value="ID">Idaho</option>
            <option value="IL">Illinois</option>
            <option value="IN">Indiana</option>
            <option value="IA">Iowa</option>
            <option value="KS">Kansas</option>
            <option value="KY">Kentucky</option>
            <option value="LA">Louisiana</option>
            <option value="ME">Maine</option>
            <option value="MD">Maryland</option>
            <option value="MA">Massachusetts</option>
            <option value="MI">Michigan</option>
            <option value="MN">Minnesota</option>
            <option value="MS">Mississippi</option>
            <option value="MO">Missouri</option>
            <option value="MT">Montana</option>
            <option value="NE">Nebraska</option>
            <option value="NV">Nevada</option>
            <option value="NH">New Hampshire</option>
            <option value="NJ">New Jersey</option>
            <option value="NM">New Mexico</option>
            <option value="NY">New York</option>
            <option value="NC">North Carolina</option>
            <option value="ND">North Dakota</option>
            <option value="OH">Ohio</option>
            <option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option>
            <option value="PA">Pennsylvania</option>
            <option value="RI">Rhode Island</option>
            <option value="SC">South Carolina</option>
            <option value="SD">Sotuh Dakota</option>
            <option value="TN">Tennessee</option>
            <option value="TX">Texas</option>
            <option value="UT">Utah</option>
            <option value="VT">Vermont</option>
            <option value="VA">Virginia</option>
            <option value="WA">Washington</option>
            <option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option>
            <option value="WY">Wyoming</option>
        </optgroup>
        <optgroup label="Territories">
            <option value="AS">American Samoa</option>
            <option value="DC">District of Columbia</option>
            <option value="GU">Guam</option>
            <option value="MP">Northern Mariana Islands</option>
            <option value="PR">Puerto Rico</option>
            <option value="VI">US Virgin Islands</option>
        </optgroup>
    </select><br><br>

    <label for="color_number">Number of Colors (4 or 5 recommended):</label>
    <input id="color_number" type="number" min="1" max="8" value="4"><br><br>
    <div id="colorPickers"></div> <!-- To put the color pickers into based on how many colors the user picked -->
    <br>

    <button onclick="runColoring()">Run</button><br><br>

    <!-- Create pre-formatted text block for results to be added to and be displayed -->
    <pre id="output" style="max-width: 95vw; white-space: pre-wrap;"></pre>

    <div id="map" style="height: 520px; width: 95vw; margin-top: 12px; display: none;"></div>

    <script type="text/javascript">

        const colorNumberInput = document.getElementById("color_number");

        // Prevent user from inputting color number that is out of range
        colorNumberInput.addEventListener("input", () => {
            const min = parseInt(colorNumberInput.min);
            const max = parseInt(colorNumberInput.max);
            const value = parseInt(colorNumberInput.value);

            // Put value back in allowed range if it goes outside of it
            if (value < min) colorNumberInput.value = min;
            if (value > max) colorNumberInput.value = max;
        });

        // Dynamically generate color pickers when user changes number of colors

        // Run updateColorPickers function every time the "color_number" value changes
        colorNumberInput.addEventListener("input", updateColorPickers);

        // Function to create and update color pickers
        function updateColorPickers() {
            // Read current color number value and convert it to an integer
            const numColors = parseInt(document.getElementById("color_number").value);

            // Grab the div we are gonna put the color pickers into
            const color_pickers = document.getElementById("colorPickers");

            // Clear old color pickers
            color_pickers.innerHTML = "";

            // Actually create the "numColors" amount of color pickers
            for (let i = 0; i < numColors; i++) {
                const label = document.createElement("label");
                label.textContent = `Color ${i + 1}: `;

                // Create a color picker html element (the native browser color chooser)
                const input = document.createElement("input");
                input.type = "color";
                input.id = `colorPicker${i}`;
                // Create default values for each picker
                input.value = ["#ff0000", "#00ff00", "#0000ff", "#ffff00", "#ff00ff", "#00ffff", "#ff8000", "#8000ff"][i] || "#000000";

                color_pickers.appendChild(label);
                color_pickers.appendChild(input);
                color_pickers.appendChild(document.createElement("br"));  // So that the next picker is on its own line
            }
        }

        // Initialize color pickers at page startup
        updateColorPickers();


        // Pyodide is a WebAssembly-based version of Python that runs directly in the browser
        let pyodideReadyPromise = loadPyodide();

        // Pyodide runs asynchronously (needs to use 'await') so function needs to be async
        async function runColoring() {
            // Wait for Pyodide to be fully loaded
            const pyodide = await pyodideReadyPromise;

            // Load county adjacency data file into Pyodide's in-memory file system
            const dataResponse = await fetch("county_adjacency2025.txt");
            const dataText = await dataResponse.text();  // read fetched file as text
            // Write file into Pyodideâ€™s virtual file system, so Python code running inside Pyodide can access it as if it were a real file
            pyodide.FS.writeFile("county_adjacency2025.txt", dataText);

            // Load colorer.py into Pyodide's in-memory file system, just as we did with county adjacency data
            const response = await fetch("colorer.py");
            const code = await response.text();
            pyodide.FS.writeFile("colorer.py", code);

            const state_dropdown = document.getElementById('state');
            const state_abbrev = state_dropdown.value;
            const state_name = state_dropdown.options[state_dropdown.selectedIndex].text;

            // Run enclosed Python code in browser
            await pyodide.runPythonAsync(`
            from colorer import load_county_data, color_state_counties
            import json

            state = "${state_abbrev}"
            state_name = "${state_name}"

            # Stringify transforms JavaScript array into list of strings that Python can read
            # "..." is the spread operator that transforms the mapped array into a literal array
            # Array.from(...).map transforms the colorPickers element into an array containing only its values (the hex values of each color)
            user_colors = ${JSON.stringify([...Array.from(document.querySelectorAll('#colorPickers input')).map(i => i.value)])}
            
            county_borders, states = load_county_data()

            if state not in states:  # should not happen, put it here just in case I messed up somewhere with my state dropdown
                result = f"Error: {state} is not a valid state abbreviation."
                color_assignments_json = {}
            else:
                color_assignments, success = color_state_counties(state, county_borders, user_colors)
                if success:
                    result = f"Successfully colored all counties or county equivalents in {state_name}!"
                else:
                    result = f"Could not color all counties or county equivalents in {state_name} with {len(user_colors)} colors."
                # Produce JSON of color asssignments
                color_assignments_json = json.dumps(color_assignments)
            `);

            // Retrieves Python variable "result" from Pyodide's global scope and displays it in the "pre" block defined earlier
            document.getElementById("output").textContent = pyodide.globals.get("result");

            let color_assignments_JSON = pyodide.globals.get("color_assignments_json")
            let color_assignments = {}
            try {
                color_assignments = JSON.parse(color_assignments_JSON || "{}");
            }
            catch (e) {
                console.error("Failed to parse colorsJSON: ", e, color_assignments_JSON);
            }

            // If there are any color assignments, show the map
            if (Object.keys(color_assignments).length > 0) {
                document.getElementById("map").style.display = "block";
                showMap(color_assignments);
            }
        }


        let leafletMap = null;
        let currentLayer = null;

        async function showMap(color_assignments) {
            // If map has not been created yet...
            if (!leafletMap) {
                // Create a Leaflet map inside the "map" element created earlier
                // preferCanvas = use HTML canvas rendering (better performance when there's a lot of shapes)
                // setView sets the initial map center and zoom to the containental US
                leafletMap = L.map('map', { preferCanvas: true }).setView([39, -98], 4);

                // Add base layer from OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(leafletMap);  // attach basemap to map object
            }

            // Remove previously colored map layer if it exists
            if (currentLayer) {
                leafletMap.removeLayer(currentLayer);
                currentLayer = null;
            }

            // Fetch the county boundary geojson file
            const resp = await fetch('county_boundaries.geojson');
            // Parse geojson into a JavaScript object
            const geojson = await resp.json();
            // Fix Aleutian Islands wrap-around issue
            fixAlaskaCoordinates(geojson);


            // Create GeoJSON layer with only the counties of the current state
            currentLayer = L.geoJSON(geojson, {
                // Filter down to only counties with a color currently assigned to them
                filter: function (feature) {
                    const props = feature.properties || {};
                    const county = getCountyCode(props);
                    // Check if county exists and is in our color assignments
                    if (county && (county in color_assignments)) return true;
                    return false;
                },
                style: styleFeature,  // use styleFeature function to color each polygon
                onEachFeature: function (feature, layer) {
                    const props = feature.properties || {};
                    const geoid = getCountyCode(props) || "unknown";
                    const name = props.coty_name_long || "Unnamed County";
                    layer.bindPopup(`<strong>${name}</strong><br>GEOID: ${geoid}`);
                }
            }).addTo(leafletMap);  // Put layer for current state on map

            // Zoom to the bounds of the current state if the map layer has valid geographical bounds
            if (currentLayer && currentLayer.getBounds && currentLayer.getBounds().isValid()) {
                leafletMap.fitBounds(currentLayer.getBounds(), { padding: [10, 10] });
            }


            // ================== //
            //  HELPER FUNCTIONS  //
            // ================== //

            // Helper function to get county code ("coty_code") from geojson
            function getCountyCode(props) {
                // Stop if county has no properties (shouldn't happen)
                if (!props) return null;

                // Try to retrieve property called "coty_code", null if it doesn't exist
                let county_code = props.coty_code || null;

                // If county code exists, convert to string and make sure it is 5 characters long
                if (county_code) return String(county_code).padStart(5, '0');  // add leading zeros if needed
                return null;
            }

            // Style function that consults the color assignments
            function styleFeature(feature) {
                const props = feature.properties || {};
                const county_code = getCountyCode(props);  // get GEOID of county

                // Check if county code exists and is in the current state's color assignments
                // If yes: use that color for fill color, if no: color the county gray
                const hex = (county_code && color_assignments[county_code]) ? color_assignments[county_code] : '#cccccc';  // default to gray as a fallback
                return {
                    color: '#222',  // border stroke color
                    weight: 0.6,  // border thickness
                    fillColor: hex,  // fill color retrieved from the color assignments
                    fillOpacity: 0.85  // transparency
                };
            }

            // Fix Aleutian Islands wrap-around issue
            function fixAlaskaCoordinates(geojson) {
                // Iterate over each feature in dataset
                geojson.features.forEach(feature => {
                    // Grab geometry object for current feature (type and coordinates)
                    const geom = feature.geometry;
                    // Make sure geometry exists and actually has coordinates before messing with them
                    if (geom && geom.coordinates) {
                        // Define recursive inner helper function to walk through nested coordinate arrays
                        const fixCoords = coords => {
                            return coords.map(c => {
                                // If more info is nested further (not yet at lat and long) walk further using recursive call
                                if (Array.isArray(c[0])) return fixCoords(c);
                                const [lon, lat] = c;
                                // Return new coordinate pair with longitude possibly normalized
                                return [normalizeLongitude(lon), lat];
                            });
                        };
                        // Replace geometry's coordinates with the normalized coordinates produced by fixCoords
                        geom.coordinates = fixCoords(geom.coordinates);
                    }
                });
            }

            function normalizeLongitude(lon) {
                // If longitude is greater than 0 but should be mapped in western hemisphere instead of eastern, shift by -360
                return lon > 0 ? lon - 360 : lon;
            }
        }

    </script>

</body>

</html>